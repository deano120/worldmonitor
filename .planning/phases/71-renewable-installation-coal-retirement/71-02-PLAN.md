---
phase: 71-renewable-installation-coal-retirement
plan: 02
type: execute
wave: 2
depends_on:
  - 71-01
files_modified:
  - src/components/RenewableEnergyPanel.ts
  - src/App.ts
  - src/styles/happy-theme.css
autonomous: true
requirements:
  - ENERGY-01
  - ENERGY-03

must_haves:
  truths:
    - "The renewable energy panel shows a D3 chart with solar capacity (gold/yellow area) and wind capacity (blue area) growing over time as a stacked area chart"
    - "The same chart shows coal capacity as a declining red trend line, making coal retirement visually obvious"
    - "The chart is labeled 'US Installed Capacity (EIA)' to distinguish from the global World Bank gauge above"
    - "Both the existing World Bank gauge and the new EIA capacity chart are visible simultaneously in the panel"
    - "If EIA data fails to load, the existing gauge/sparkline/regions still render normally — the capacity section shows a graceful empty state"
  artifacts:
    - path: "src/components/RenewableEnergyPanel.ts"
      provides: "setCapacityData() method with D3 stacked area + coal decline chart"
      contains: "setCapacityData"
    - path: "src/App.ts"
      provides: "loadRenewableData() calls fetchEnergyCapacity() and passes to panel"
      contains: "fetchEnergyCapacity"
  key_links:
    - from: "src/App.ts"
      to: "src/services/renewable-energy-data.ts"
      via: "import fetchEnergyCapacity"
      pattern: "fetchEnergyCapacity"
    - from: "src/App.ts"
      to: "src/components/RenewableEnergyPanel.ts"
      via: "this.renewablePanel?.setCapacityData(capacity)"
      pattern: "setCapacityData"
    - from: "src/components/RenewableEnergyPanel.ts"
      to: "d3"
      via: "D3 stack + area generators for capacity chart"
      pattern: "d3\\.stack|d3\\.area"
---

<objective>
Add EIA capacity visualization to the RenewableEnergyPanel: a D3 stacked area chart showing solar + wind growth and coal decline, wired into App.ts data loading.

Purpose: Users see solar/wind installation growth and coal retirement as a clear visual trend, alongside the existing World Bank renewable percentage gauge. This closes the Phase 7 verification gap.

Output: Updated RenewableEnergyPanel with `setCapacityData()`, updated App.ts `loadRenewableData()`, supporting CSS.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/71-renewable-installation-coal-retirement/71-RESEARCH.md
@.planning/phases/71-renewable-installation-coal-retirement/71-01-SUMMARY.md

@src/components/RenewableEnergyPanel.ts
@src/services/renewable-energy-data.ts
@src/App.ts
@src/styles/happy-theme.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setCapacityData() with D3 stacked area chart to RenewableEnergyPanel</name>
  <files>
    src/components/RenewableEnergyPanel.ts
    src/styles/happy-theme.css
  </files>
  <action>
    **1. Add import for CapacitySeries type** at the top of RenewableEnergyPanel.ts:
    ```typescript
    import type { CapacitySeries } from '@/services/renewable-energy-data';
    ```

    **2. Add `setCapacityData()` public method** to the RenewableEnergyPanel class.

    This method renders BELOW the existing gauge/sparkline/regions content. It does NOT call `replaceChildren()` — it appends to the existing content. If content is empty (setData not called yet), it creates the container.

    Implementation:

    ```typescript
    public setCapacityData(series: CapacitySeries[]): void {
      // Remove any existing capacity section (idempotent re-render)
      this.content.querySelector('.capacity-section')?.remove();

      if (!series || series.length === 0) return;

      const section = document.createElement('div');
      section.className = 'capacity-section';
      // Add a section header
      const header = document.createElement('div');
      header.className = 'capacity-header';
      header.textContent = 'US Installed Capacity (EIA)';
      section.appendChild(header);

      // Build the chart
      this.renderCapacityChart(section, series);
      this.content.appendChild(section);
    }
    ```

    **3. Add `renderCapacityChart()` private method**.

    This creates a SINGLE compact chart (~110px tall) with:
    - Stacked area for solar (yellow/gold) + wind (blue) — these are additive renewable capacity
    - Overlaid declining line for coal (red) — plotted on the same y-axis for scale comparison
    - X-axis: years (first, middle, last labeled)
    - Y-axis: implied by chart height, no explicit axis labels (keep compact)
    - Small inline legend below the chart: colored circles + labels

    Steps:
    a. Prepare data: Find the solar and wind series from the input. Build a combined dataset of `{ year, solar, wind }` objects for the stacked area. Find the coal series for the overlay line.

    b. Use `d3.stack()` with keys `['solar', 'wind']` and `d3.stackOrderNone` / `d3.stackOffsetNone`.

    c. Chart dimensions: Use `this.content.clientWidth - 16` for width (or 200 fallback), height = 100px, margins: `{ top: 4, right: 8, bottom: 16, left: 8 }`.

    d. Create SVG with proper viewBox for responsive display.

    e. X scale: `d3.scaleLinear()` domain from min year to max year across all series.

    f. Y scale: `d3.scaleLinear()` domain from 0 to max of (stacked renewable peak, coal peak) with 10% padding.

    g. Render stacked areas using `d3.area()` with `d3.curveMonotoneX`:
       - Solar: fill with `getCSSColor('--yellow')` at opacity 0.6
       - Wind: fill with `getCSSColor('--semantic-info')` (blue) at opacity 0.6

    h. Render coal as a declining area/line:
       - Use `d3.area()` with y0 = height, y1 = coal value, fill with `getCSSColor('--red')` at opacity 0.2
       - Overlay `d3.line()` stroke with `getCSSColor('--red')` at opacity 0.8, stroke-width 1.5

    i. Add year labels on x-axis: first year, last year (as text elements at bottom).

    j. Add compact inline legend below chart as HTML div:
       - Three items: colored dot (8px circle) + label for Solar, Wind, Coal
       - Use flexbox with gap: 12px, font-size: 10px, color: var(--text-dim)

    **4. Style the capacity section in happy-theme.css**:

    Add these scoped styles under `[data-variant='happy']`:
    ```css
    [data-variant='happy'] .capacity-section {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    [data-variant='happy'] .capacity-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 8px;
      text-align: center;
    }

    [data-variant='happy'] .capacity-legend {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-dim);
    }

    [data-variant='happy'] .capacity-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    [data-variant='happy'] .capacity-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    ```
  </action>
  <verify>
    1. `npx tsc --noEmit` passes for RenewableEnergyPanel.ts
    2. `grep "setCapacityData" src/components/RenewableEnergyPanel.ts` returns the public method
    3. `grep "d3.stack" src/components/RenewableEnergyPanel.ts` confirms D3 stacked area usage
    4. `grep "capacity-section" src/styles/happy-theme.css` confirms CSS styles exist
  </verify>
  <done>
    RenewableEnergyPanel has a `setCapacityData()` method that renders a compact D3 stacked area chart (solar yellow + wind blue) with coal decline (red) below the existing gauge, labeled "US Installed Capacity (EIA)" with an inline legend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire capacity data loading in App.ts</name>
  <files>src/App.ts</files>
  <action>
    **1. Update the import** from `@/services/renewable-energy-data`:
    Add `fetchEnergyCapacity` to the existing import that already imports `fetchRenewableEnergyData`.

    **2. Update `loadRenewableData()`** method in App.ts:

    The existing method is:
    ```typescript
    private async loadRenewableData(): Promise<void> {
      const data = await fetchRenewableEnergyData();
      this.renewablePanel?.setData(data);
    }
    ```

    Change to:
    ```typescript
    private async loadRenewableData(): Promise<void> {
      const data = await fetchRenewableEnergyData();
      this.renewablePanel?.setData(data);

      // EIA capacity data (solar/wind growth, coal decline) — independent of World Bank gauge
      try {
        const capacity = await fetchEnergyCapacity();
        this.renewablePanel?.setCapacityData(capacity);
      } catch {
        // EIA failure does not break the existing World Bank gauge
      }
    }
    ```

    This follows the research recommendation: EIA data loading is wrapped in its own try/catch so the World Bank gauge always renders, even if EIA is down or API key is missing. The `fetchEnergyCapacity()` function already has internal error handling (returns `[]` on failure), but the outer try/catch is defense-in-depth.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. `grep "fetchEnergyCapacity" src/App.ts` shows the import and call
    3. `grep "setCapacityData" src/App.ts` shows the panel method call
    4. The `loadRenewableData` method has both `setData` (World Bank) and `setCapacityData` (EIA) calls
  </verify>
  <done>
    App.ts loadRenewableData() fetches both World Bank renewable percentage (existing) and EIA capacity data (new), passing each to the panel via separate methods. EIA failure is gracefully handled without affecting the existing gauge.
  </done>
</task>

</tasks>

<verification>
1. The renewable energy panel shows the existing gauge + sparkline + regions from World Bank data (no regression)
2. Below the existing sections, a new "US Installed Capacity (EIA)" section shows a D3 stacked area chart
3. Solar capacity appears as yellow/gold area growing upward over time
4. Wind capacity appears as blue area stacked on top of solar, also growing
5. Coal capacity appears as a red declining area/line showing closures
6. A compact legend identifies the three series
7. If EIA API is unavailable, the gauge still renders and the capacity section simply doesn't appear
8. The panel does not overflow excessively — capacity chart is ~110px tall
</verification>

<success_criteria>
- RenewableEnergyPanel.setCapacityData() renders D3 stacked area chart with solar, wind, coal
- App.ts calls fetchEnergyCapacity() and passes data to panel
- TypeScript compilation passes
- Existing World Bank gauge unaffected by new code
- Chart uses theme-aware colors via getCSSColor()
- Chart labeled "US Installed Capacity (EIA)" to distinguish from global data
</success_criteria>

<output>
After completion, create `.planning/phases/71-renewable-installation-coal-retirement/71-02-SUMMARY.md`
</output>
