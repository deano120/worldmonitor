---
phase: 06-content-spotlight-panels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/GoodThingsDigestPanel.ts
autonomous: true
requirements:
  - DIGEST-01
  - DIGEST-02

must_haves:
  truths:
    - "GoodThingsDigestPanel class exists, extends Panel, and displays 5 curated stories with AI-generated summaries"
    - "Story titles render immediately before summarization completes (progressive rendering)"
    - "Summaries are generated via generateSummary() from summarization.ts, not raw mlWorker.summarize()"
    - "Panel gracefully handles summarization failures by showing truncated titles as fallback"
  artifacts:
    - path: "src/components/GoodThingsDigestPanel.ts"
      provides: "5 Good Things digest panel with AI summarization"
      contains: "extends Panel"
  key_links:
    - from: "src/components/GoodThingsDigestPanel.ts"
      to: "src/components/Panel.ts"
      via: "class extends Panel"
      pattern: "extends Panel"
    - from: "src/components/GoodThingsDigestPanel.ts"
      to: "src/services/summarization.ts"
      via: "generateSummary import"
      pattern: "generateSummary"
---

<objective>
Create the GoodThingsDigestPanel that displays the top 5 positive stories of the day, each with an AI-generated summary of 50 words or less.

Purpose: This panel turns the best stories of the day into a concise, scannable digest. It demonstrates the AI summarization capability already built into the platform (Flan-T5 / cloud providers via generateSummary()).

Output: One new Panel subclass with progressive rendering (titles first, summaries fill in asynchronously).
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-content-spotlight-panels/06-RESEARCH.md
@src/components/Panel.ts
@src/components/CountersPanel.ts
@src/services/summarization.ts
@src/types/index.ts
@src/utils/sanitize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoodThingsDigestPanel with progressive AI summarization</name>
  <files>src/components/GoodThingsDigestPanel.ts</files>
  <action>
Create `src/components/GoodThingsDigestPanel.ts` extending `Panel` with `{ id: 'digest', title: '5 Good Things', trackActivity: false }`.

**Structure:**

- `private cardElements: HTMLElement[] = [];`
- `private abortController: AbortController | null = null;`
- Constructor calls `super(...)` then sets a default empty state in `this.content.innerHTML` ("Loading today's digest...").

**`public async setStories(items: NewsItem[]): Promise<void>`:**

1. Cancel any previous summarization batch: if `this.abortController`, call `.abort()`. Create a new `AbortController`.
2. Take the first 5 items: `const top5 = items.slice(0, 5);`
3. If `top5.length === 0`, show "No stories available" in `this.content.innerHTML` and return.
4. **Render stub cards immediately** (titles only, no summaries yet):
   ```
   this.content.innerHTML = '';
   const list = document.createElement('div');
   list.className = 'digest-list';
   this.cardElements = [];
   for (let i = 0; i < top5.length; i++) {
     const card = document.createElement('div');
     card.className = 'digest-card';
     card.innerHTML = `
       <span class="digest-card-number">${i + 1}</span>
       <div class="digest-card-body">
         <a class="digest-card-title" href="${sanitizeUrl(top5[i].link)}" target="_blank" rel="noopener">
           ${escapeHtml(top5[i].title)}
         </a>
         <span class="digest-card-source">${escapeHtml(top5[i].source)}</span>
         <p class="digest-card-summary digest-card-summary--loading">Summarizing...</p>
       </div>
     `;
     list.appendChild(card);
     this.cardElements.push(card);
   }
   this.content.appendChild(list);
   ```

5. **Summarize in parallel with progressive updates:**
   ```typescript
   const signal = this.abortController.signal;
   await Promise.allSettled(top5.map(async (item, idx) => {
     if (signal.aborted) return;
     try {
       const result = await generateSummary([item.title], undefined, item.locationName);
       if (signal.aborted) return;
       const summary = result?.summary ?? item.title.slice(0, 200);
       this.updateCardSummary(idx, summary);
     } catch {
       if (!signal.aborted) {
         this.updateCardSummary(idx, item.title.slice(0, 200));
       }
     }
   }));
   ```

**`private updateCardSummary(idx: number, summary: string): void`:**
Find the `.digest-card-summary` element within `this.cardElements[idx]`. Replace its text content with `escapeHtml(summary)`. Remove the `digest-card-summary--loading` class.

**`public destroy(): void`:**
- If `this.abortController`, call `.abort()` and set to null.
- `this.cardElements = [];`
- Call `super.destroy()`.

**Imports:**
- `Panel` from `./Panel`
- `NewsItem` from `@/types`
- `generateSummary` from `@/services/summarization`
- `escapeHtml`, `sanitizeUrl` from `@/utils/sanitize`

**CRITICAL anti-patterns to avoid:**
- Do NOT use `mlWorker.summarize()` directly. Always use `generateSummary()` which provides Redis caching + cloud provider chain.
- Do NOT block panel rendering on summarization. Titles render first, summaries fill in progressively.
- Do NOT concatenate all 5 titles into one summarization call. Each story gets its own summary for independent progressive rendering.
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors. Verify the file imports `generateSummary` (not mlWorker). Verify setStories renders titles before awaiting summaries.</verify>
  <done>GoodThingsDigestPanel class exists, extends Panel, renders 5 numbered story cards with titles immediately, then fills in AI summaries progressively via generateSummary(). Handles abort on re-render and fallback on summarization failure.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `src/components/GoodThingsDigestPanel.ts` exists and exports `GoodThingsDigestPanel`
3. File imports `generateSummary` from `@/services/summarization` (not raw mlWorker)
4. File renders titles before awaiting summarization results
5. Summarization uses `Promise.allSettled()` for parallel execution
6. AbortController cancels in-flight summaries on destroy or re-render
</verification>

<success_criteria>
- GoodThingsDigestPanel compiles and follows the established Panel pattern
- Progressive rendering: titles visible immediately, summaries appear as they resolve
- Uses the production summarization chain (generateSummary), not raw worker
- No type errors in the project
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-spotlight-panels/06-02-SUMMARY.md`
</output>
